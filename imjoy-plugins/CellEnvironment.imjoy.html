<docs lang="markdown">
[TODO: write documentation for this plugin.]
</docs>

<config lang="json">
{
  "name": "CellEnvironment",
  "type": "native-python",
  "version": "0.1.0",
  "description": "Calculate expression levels around annotated regions.",
  "tags": ["stable","dev"],
  "ui": "",
  "cover": "",
  "inputs": null,
  "outputs": null,
  "flags": [],
  "icon": "extension",
  "api_version": "0.1.7",
  "env": "conda create -n rna-loc-liver python=3.6",
  "permissions": [],
  "requirements": {"stable":["pip: matplotlib scikit-image numpy pandas",
                             "pip: -U git+https://github.com/muellerflorian/walesky-rna-loc-liver@5483191"],
                     "dev": ["pip: matplotlib scikit-image numpy pandas",
                             "pip:  -U --editable D:\\Documents\\code\\GitHub\\projects\\walesky-rna-loc-liver"]},
  "dependencies": []
}
</config>

<script lang="python">
from imjoy import api

import asyncio
import sys

from pathlib import Path
import os

from fqa import cell_environment

if sys.platform == "darwin":
    import matplotlib
    matplotlib.use('PS')

class ImJoyPlugin():
    def setup(self):
        api.log('CellEnvironment plugin initialized')

        # Prepare data
        api.register({
            "name": "Press to define folder",
            "type": "op",
            "ui": "Define folder for processing",
            "run":self.define_folder
        })

        # Prepare data
        api.register({
            "name": "Press to run analysis",
            "type": "op",
            "ui": [
                    "Region label: {id: 'reg_label', type: 'string', placeholder: 'Cells'}",
                    "Annotation file: {id: 'annotation_file', type: 'string', placeholder: 'annotation.json'}",
                    "Hist [min]: {id: 'hist_min', type: 'number', placeholder: 0}",
                    "Hist [max]: {id: 'hist_max', type: 'number', placeholder: 300}",
                    "Hist [bin_size]: {id: 'hist_bin_size', type: 'number', placeholder: 50}"
                ],
            "run":self.run_analysis
        })

    async def define_folder(self,ctx):
        """
        Define folder to be processed.
        """
        ret_data = await api.showFileDialog(title="Please select a folder containing data to pre-process", type= 'directory', engine=api.ENGINE_URL)
        if not ret_data:
            return
        path_user = ret_data.path

        # Ugly patch to correct for bug in showFileDialog which returns \ for subfolders
        if (path_user[0] == '\\') or (path_user[0] == r'/'):
            api.log(f'Returned path will be manually corrected: {path_user}')
            path_user=path_user[1:]

        # Get scan folder
        path_scan = Path.cwd() / Path(path_user)
        api.log(f'Specified folder: {str( Path(path_user))}')
        api.log(f'Current working directory: {str(Path.cwd())}')
        api.log(f'Path to process: {str(path_scan)}')
        self.path_scan = path_scan

        # Change ui of registered op
        api.register({
            "name": "Press to define folder",
            "type": "op",
            "ui": str(path_scan),
            "run":self.define_folder
        })
        
    async def run_analysis(self,ctx):
        """
        Analyse specified folder.
        """
        
        cell_environment.process_folder(
            path_scan = self.path_scan, 
            region_label = ctx.config.reg_label, 
            bin_prop = (ctx.config.hist_min,ctx.config.hist_max,ctx.config.hist_bin_size), 
            annotation_file = ctx.config.annotation_file, 
            callback_log = api.log, 
            callback_status = api.showStatus,
            callback_progress = api.showProgress)


    async def run(self, ctx):

        api.log('Use specific plugin ops.')
        
api.export(ImJoyPlugin())
</script>
